<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Conclusion</title>
    <style type="text/css">

        .tooltip {
            position: absolute;
            text-align: center;
            padding: 2px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
        }

        input#Category {
            background-color:rgba(0, 0, 0, 0);
            color:black;
            border: none;
            outline:none;

        }

        .text {
          font: 14px sans-serif;
          text-color:red;
        }
        .next {
            float: right;
            background-color: #4CAF50;
            color: white;
		}
        .previous {
            float: right;
            background-color: #bac1ba;
            color: black;
	    }

	    div#nav {
	        height: 5px;
	    }

	    .axis text {
          font: 18px sans-serif;
        }
    </style>

</head>
<script src='https://d3js.org/d3.v5.min.js'></script>
<body onload="init()">
<div>
    <!-- Trigger -->
    <left>
        <label for="mpgCategory">Select MPG category</label>
        <select id="mpgCategory" onchange="changeCategory()"></select>
    </left>
</div>

<div style="text-align:right; float: right;" id="nav">
    <table style="margin-left:auto;margin-right:auto;">
        <tr>
            <td>
                <a href="fuelbasedcomparison.html" class="previous">Previous Slide</a>
            </td>
            <td></td>
            <td>

            </td>
            <td></td>
            <td>
                <a href="index.html" class="next">Start Over</a>
            </td>
        </tr>
    </table>
</div>

<div>
    <h3> <label for="Category">Top 10 based on </label>
        <input style="font: 30px sans-serif ;" id="Category" value="Average City MPG" disabled ></h3>
    <svg></svg>
</div>

<script defer>
// Define canvas scales
var svgWidth = screen.width - 300;
var svgHeight = 400;
var margin = 50;
var width = svgWidth -  margin;
var height = svgHeight -  2 * margin;

var xs;
var ys;
var cs = d3.scaleLinear().domain([0, 10]).range(["darkgreen","lightgreen"]);

// Define triggers
var categories = [{"label":"Average City MPG", "value": "AverageCityMPG"},
                  {"label": "Average Highway MPG", "value": "AverageHighwayMPG"}];

var svg = d3.select("svg")
            .attr("width", svgWidth)
            .attr("height", svgHeight)
            .append("g")
            .attr("transform", "translate(" + margin + "," + 0 + ")");

var x_axis = svg.append("g")
           .attr("transform", "translate("+margin+","+(height + margin)+")");

var y_axis = svg.select("g")
                .attr("class", "my_y")
                .attr("transform", "translate("+margin+","+margin+")");

var tooltipDiv = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

async function init() {
    const data = await d3.csv("cars2017.csv", function(d) {
        return {Make: d.Make+"_"+d.EngineCylinders, Fuel: d.Fuel, EngineCylinders: d.EngineCylinders, AverageHighwayMPG: d.AverageHighwayMPG, AverageCityMPG: d.AverageCityMPG, OnlyMake: d.Make }
    });

    xs = d3.scaleBand().padding(0.5).range([0, width]);
    ys = d3.scaleLinear().range([height, 0]);


    // https://stackoverflow.com/questions/24588883/populate-dropdown-list-with-csv-file-d3
    d3.select("#mpgCategory")
        .selectAll("option")
        .data(categories)
        .enter()
        .append("option")
        .attr("value", function (d) { return d.value; })
        .text(function (d) { return d.label; });

    updateChart(data);

}

function updateChart(data) {

    var cat = document.getElementById("mpgCategory");
    var category = cat.options[cat.selectedIndex].value;

    svg.selectAll("rect").remove();
    svg.selectAll("text").remove();
    var topData = data.filter(function(d) {return d.EngineCylinders > 0;}).sort(function(a,b) {
        return b[category] - a[category];
    }).slice(0, 10);
    xs.domain(topData.map(function(d) { return d.Make; }));
    var y_min = d3.min(topData, function(d) {return d[category];});
    var y_max = d3.max(topData, function(d) {return d[category];});
    ys.domain([d3.min(topData, function(d) {return d[category];}) - 5, d3.max(topData, function(d) {return d[category];})]);
    var g = svg.append("g")
        .attr("transform", "translate("+margin+","+margin+")");
      g.selectAll("rect")
            .data(topData)
            .enter()
            .append("rect")
                .attr("x", function(d) {return xs(d.Make);})
                .attr("y", function(d) {return  ys(d[category])})
                .attr("width", xs.bandwidth())
                .attr("height", function(d) {return height - ys(d[category]);})
                .attr("fill", function(d, i) {return cs(i)})
                .on("mouseover", function(d) {
                    tooltipDiv.transition()
                        .duration(200)
                        .style("opacity", 0.9);
                    tooltipDiv.html("Make: " + d.OnlyMake + "</br>" + "Fuel type: "+ d.Fuel + "</br>" +"Cylinders: " + d.EngineCylinders + "<br/>"  + "Average MPG: " + d[category])
                        .style("left", (d3.event.pageX + 30) + "px")
                        .style("top", (d3.event.pageY - 30) + "px");
                })
                .on("mouseout", function(d) {
                    tooltipDiv.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

    var text = g.selectAll("text")
        .data(topData)
        .enter()
        .append("text");

    text.attr("x", function(d) {return xs(d.Make);})
        .attr("y", function(d) {return  ys(d[category]) - 3;})
        .attr("class", "axis")
        .text(function(d) {
            return d.Fuel;
       });

    svg.append("g")
           .attr("transform", "translate("+margin+","+(height + margin)+")")
           .attr("class", "text")
           .text("Make")
          .transition()
          .duration(1000)
          .call(d3.axisBottom(xs));

    // text label for the x axis
    svg.append("text")
      .attr("transform",
            "translate(" + (width/2) + " ," +
                           (height + margin + 40) + ")")
      .style("text-anchor", "middle")
      .attr("class", "axis")
      .text("Make");

    y_axis.text(cat.options[cat.selectedIndex].text)
          .transition()
          .duration(1000)
          .call(d3.axisLeft(ys));

    // text label for the y axis
    svg.append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 0 - margin.left)
      .attr("x",0 - (height / 2))
      .attr("dy", "1em")
      .style("text-anchor", "middle")
      .text(cat.options[cat.selectedIndex].text);

    // Annotations
    // mouseover text
     svg.append('g')
        .append('text')
        .transition()
        .duration(3000)
        .attr("x", width - 250)
        .attr("y", svgHeight - 10)
        .attr("id","anno")
        .text("Please mouse over individual bar for more details..")
        .attr("font-size", "12px")
        .attr("font-weight","italic")
        .style("fill", "gray");

     // anomaly test
    svg.append("text")
        .attr("y", 45)
        .attr("dy", ".15em")
        .attr('text-anchor', 'middle')
        .attr("class", "text")//easy to style with CSS
        .attr("transform", "translate(900,35) rotate(0)")
        .attr("fill", "black")
        .transition()
        .duration(3000)
        .text("Honda has 2 models with 4 cylinder count thus overlap.");

    if(category == "AverageCityMPG") {
        svg.select("line.AverageHighwayMPG").remove();
        svg.append("line")
            .attr("class", category)
            .attr("x1", 830)
            .attr("y1", 190)
            .attr("x2", 870)
            .attr("y2", 100)
            .transition()
            .duration(1000)
            .style("stroke","red")
            .style("stroke-width","2");

    } else {
        svg.select("line.AverageCityMPG").remove();
        svg.append("line")
            .attr("class", category)
            .attr("x1", 750)
            .attr("y1", 160)
            .attr("x2", 790)
            .attr("y2", 100)
            .transition()
            .duration(1000)
            .style("stroke","red")
            .style("stroke-width","2");
    }


}

// Modify screen description based on MPG Category
async function changeCategory() {
    // Read data
    const data = await d3.csv("cars2017.csv", function(d) {
        return {Make: d.Make+"_"+d.EngineCylinders, Fuel: d.Fuel, EngineCylinders: d.EngineCylinders, AverageHighwayMPG: d.AverageHighwayMPG, AverageCityMPG: d.AverageCityMPG, OnlyMake: d.Make }
    });
    data.sort(function(a,b) {
        return a.EngineCylinders - b.EngineCylinders;
    });

    var cat = document.getElementById("mpgCategory");
    document.getElementById("Category").value = cat.options[cat.selectedIndex].text;
    selectedCategory = cat.options[cat.selectedIndex].value;
    updateChart(data);
}

</script>

</body>
</html>