<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Makes and fuel efficiency</title>
    <style type="text/css">
        .tooltip {
            position: absolute;
            text-align: center;
            padding: 2px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
        }
    </style>
</head>
<script src='https://d3js.org/d3.v5.min.js'></script>
<body onload="init()">

<div>
    <center>
        <label for="Category">Displaying chart for </label>
        <input id="Category" value="Average City MPG" readonly >
    </center>
</div>
<div>
    <!-- Trigger -->
   <left>
       <label for="mpgCategory">Select MPG category</label>
       <select id="mpgCategory" onchange="changeCategory()"></select>
   </left>
</div>


<!-- svg Canvas -->
<svg id="gasoline"></svg>
<p>Diesel data</p>
<svg id="diesel"></svg>
<div id="canvas"></div>

<input id="previous" value="Previous" type="button">
<input id="next" value="Next" type="button">

<script defer>

// Define canvas scales
var svgWidth = 800;
var svgHeight = 650;
var margin = 50;
var width = svgWidth - 2* margin;
var height = svgHeight - 2 * margin;

// Define triggers
var categories = [{"label":"Average City MPG", "value": "AverageCityMPG"},
                  {"label": "Average Highway MPG", "value": "AverageHighwayMPG"}];


var selectedCategory = "AverageCityMPG";
var gasolineSvg = d3.select("#gasoline");
var dieselSvg = d3.select("#diesel");
var xs;
var ys;
var colorscale;
var gasolineData;
var dieselData;

var dieselToolTipDiv = d3.select("body").append("div")
    .attr("class", "tooltipDiesel")
    .style("opacity", 0);

var gasolineToolTipDiv = d3.select("body").append("div")
    .attr("class", "tooltipGasoline")
    .style("opacity", 0);

async function init() {
    // Read data

    const data = await d3.csv("cars2017.csv");
    // Define scales
    var manufacturer = d3.scaleBand().domain();
    xs = d3.scaleBand().padding(0.1).range([0, width]);
    ys = d3.scaleLog().base(10).domain([10,300]).range([height, 0]);
    // https://github.com/d3/d3-scale-chromatic
    colorscale = d3.scaleOrdinal().domain(data.map(function(d) { return d.EngineCylinders; })).range(d3.schemeSet2);

    // https://stackoverflow.com/questions/24588883/populate-dropdown-list-with-csv-file-d3
    d3.select("#mpgCategory")
        .selectAll("option")
        .data(categories)
        .enter()
        .append("option")
        .attr("value", function (d) { return d.value; })
        .text(function (d) { return d.label; });

    gasolineSvg.attr("width", svgWidth)
        .attr("height", svgWidth)
        .attr("width", svgHeight)
        .style("position", "absolute");

    dieselSvg.attr("width", svgWidth)
        .attr("height", svgWidth)
        .attr("width", svgHeight)
        .style("position", "absolute");

    data.sort(function(a,b) {
        return a.EngineCylinders - b.EngineCylinders;
    });
    gasolineData = data.filter(function(d) {return d.Fuel == "Gasoline";});
    dieselData = data.filter(function(d) {return d.Fuel == "Diesel";});
    updateCharts(gasolineSvg, selectedCategory, gasolineData, gasolineToolTipDiv);
    updateCharts(dieselSvg, selectedCategory, dieselData, dieselToolTipDiv);


}


// Modify screen description based on MPG Category
async function changeCategory() {
    // Read data
    const data = await d3.csv("cars2017.csv");
    data.sort(function(a,b) {
        return a.EngineCylinders - b.EngineCylinders;
    });
    gasolineData = data.filter(function(d) {return d.Fuel == "Gasoline";});
    dieselData = data.filter(function(d) {return d.Fuel == "Diesel";});
    var cat = document.getElementById("mpgCategory");
    document.getElementById("Category").value = cat.options[cat.selectedIndex].text;
    selectedCategory = cat.options[cat.selectedIndex].value;
    updateCharts(gasolineSvg, selectedCategory, gasolineData, gasolineToolTipDiv);
    updateCharts(dieselSvg, selectedCategory, dieselData, dieselToolTipDiv);
}

function updateCharts(svg, category, data, tooltipDiv) {
    // Define the div for the tooltip
    if(data.length ==6) {
        console.log(data);
        data.forEach(function(d) {console.log(d[category]);});
    }
    svg.selectAll("rect.negative").remove();
    xs.domain(data.map(function(d) { return d.Make; }));
    var c1 = svg.append("g")
        .attr("transform", "translate("+margin+","+margin+")")
        .selectAll("rect")
            .data(data)
            .on("mouseover", function(d) {
                    tooltipDiv.transition()
                        .duration(200)
                        .style("opacity", 0.9);
                    tooltipDiv.html("Make: " + d.Make + "</br>" + "Fuel type: "+ d.Fuel + "</br>" +"Cylinders: " + d.EngineCylinders + "<br/>"  + "Average MPG: " + d[category])
                        .style("left", (d3.event.pageX + 30) + "px")
                        .style("top", (d3.event.pageY - 30) + "px");
                })
                .on("mouseout", function(d) {
                    tooltipDiv.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            c1.enter()
            .append("rect")
                .attr("x", function(d) {return xs(d.Make);})
                .attr("y", function(d) {if(data.length ==6) { d[category] };return ys(d[category])})
                .attr("width", xs.bandwidth())
                .attr("height", function(d) {return height - ys(d[category]);})
                .attr("fill", function(d) {return colorscale(d.Make)});

    svg.append("g")
        .attr("transform", "translate("+margin+","+margin+")")
        .call(d3.axisBottom(xs));

}


</script>

</body>
</html>